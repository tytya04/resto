# Контекст для Claude AI

Этот файл содержит важную информацию о проекте для работы с Claude AI.

## Описание проекта

Restaurant Procurement Bot - это Telegram бот для автоматизации закупок в ресторанах. Бот помогает ресторанам создавать заказы, менеджерам их обрабатывать, а закупщикам консолидировать для отправки поставщикам.

## Архитектура

### Технологический стек
- Node.js 18+
- Telegraf 4.x (Telegram Bot Framework)
- SQLite + Sequelize ORM
- node-cron для планировщика
- ExcelJS для работы с Excel
- Winston для логирования
- Fuse.js для нечеткого поиска

### Структура базы данных

```sql
-- Основные таблицы
users - пользователи системы
restaurants - рестораны  
restaurant_branches - филиалы ресторанов
orders - заказы
order_items - позиции заказов
draft_orders - черновики заказов
draft_order_items - позиции черновиков
nomenclature_cache - каталог продуктов
order_schedules - расписание отправки заказов
registration_requests - заявки на регистрацию
```

### Роли пользователей

1. **guest** - неавторизованный пользователь
2. **restaurant** - представитель ресторана (создает заказы)
3. **manager** - менеджер (обрабатывает заказы ресторанов)
4. **buyer** - закупщик/байер (консолидирует заказы)
5. **admin** - администратор системы

### Основные процессы

1. **Создание заказа**:
   - Ресторан выбирает филиал (если их несколько)
   - Создает черновик заказа
   - Добавляет продукты (текстом или через поиск)
   - Система автоматически распознает продукты через fuzzy matching
   - Заказ отправляется по расписанию или вручную

2. **Обработка заказа**:
   - Менеджер получает уведомление
   - Проверяет корректность заказа
   - Подтверждает или отклоняет
   - Может отредактировать позиции

3. **Консолидация**:
   - Байер видит все подтвержденные заказы
   - Может отфильтровать по дате
   - Экспортирует в Excel для поставщиков

## Ключевые особенности реализации

### Обработка текста заказов
Система использует интеллектуальный парсер для распознавания продуктов:
- Поддерживает различные форматы ввода
- Автоматически определяет количество и единицы измерения
- Использует fuzzy matching для поиска в каталоге
- Обрабатывает синонимы продуктов

### Планировщик заказов
- Автоматическая отправка заказов по расписанию
- Гибкие настройки для каждого ресторана
- Учет часовых поясов

### Система уведомлений
- Мгновенные уведомления в Telegram
- Email уведомления (опционально)
- Различные типы уведомлений для разных ролей

## Важные файлы

### Конфигурация
- `.env` - переменные окружения
- `src/config/index.js` - основная конфигурация

### Обработчики команд
- `src/handlers/registration.js` - регистрация и главное меню
- `src/handlers/restaurant.js` - функции для ресторанов
- `src/handlers/manager.js` - функции для менеджеров
- `src/handlers/procurement.js` - функции для байеров
- `src/handlers/admin.js` - административные функции
- `src/handlers/draftOrder.js` - работа с черновиками

### Сервисы
- `src/services/ProductMatcher.js` - распознавание продуктов
- `src/services/OrderSchedulerService.js` - планировщик заказов
- `src/services/NotificationService.js` - уведомления
- `src/services/ExcelExportService.js` - экспорт в Excel

### Сцены (многошаговые диалоги)
- `src/scenes/registrationScene.js` - регистрация пользователей
- `src/scenes/createOrderScene.js` - создание заказа
- `src/scenes/processOrderScene.js` - обработка заказа менеджером

## Текущие проблемы и ограничения

1. **Масштабируемость**: SQLite может быть узким местом при большой нагрузке
2. **Конфликты токенов**: При запуске нескольких экземпляров с одним токеном
3. **Сессии**: Хранятся в памяти, теряются при перезапуске

## Рекомендации по разработке

### При добавлении новых функций
1. Следуйте существующей архитектуре (handlers → services → database)
2. Добавляйте логирование для отладки
3. Обновляйте help и документацию
4. Пишите тесты для критической логики

### При работе с базой данных
1. Используйте транзакции для связанных операций
2. Добавляйте индексы для частых запросов
3. Следите за N+1 проблемами в Sequelize

### При работе с Telegram API
1. Всегда отвечайте на callback_query через answerCbQuery()
2. Используйте сцены для многошаговых диалогов
3. Ограничивайте длину сообщений (4096 символов)
4. Обрабатывайте ошибки rate limiting

## Полезные команды для отладки

```bash
# Просмотр логов
tail -f bot.log
tail -f logs/application-$(date +%Y-%m-%d).log

# Работа с БД
sqlite3 database.sqlite
.tables
.schema orders
SELECT * FROM users WHERE role='admin';

# Проверка процессов
ps aux | grep node
lsof -i :3000

# Очистка старых логов
find logs/ -name "*.log" -mtime +14 -delete
```

## Частые вопросы

**Q: Как добавить нового администратора?**
A: Используйте команду в боте `/admin` → "Управление пользователями" или через БД.

**Q: Как изменить расписание отправки заказов?**
A: Менеджер может это сделать через "Управление расписанием" в своем меню.

**Q: Как обновить каталог продуктов?**
A: Каталог обновляется автоматически из Google Sheets (если настроено) или через админ-панель.

**Q: Что делать при ошибке "Conflict: terminated by other getUpdates request"?**
A: Убедитесь, что запущен только один экземпляр бота с данным токеном.